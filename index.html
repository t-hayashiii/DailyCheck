<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日常チェックアプリ</title>

<!-- SortableJS（ドラッグ並び替え用） -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        padding: 20px;
        background: #f5f5f7;
        color: #333;
        max-width: 360px;
        margin: auto;
        font-size: 18px;
    }

    h1 {
        text-align: center;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 24px;
    }

    /* カウンター表示 */
    #counter {
        text-align: center;
        margin-bottom: 15px;
        font-size: 18px;
        font-weight: 600;
    }


    /* ---------- 各項目カード ---------- */
    .item-wrapper {
        position: relative;
        margin-bottom: 12px;
    }

    .item {
        display: grid;
        grid-template-columns: 34px 1fr 34px;
        align-items: center;
        background: #fff;
        padding: 14px 14px;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        transition: background 0.2s ease;
        font-size: 18px;
    }

    .item.checked {
        background: #e9f7ec;
        border-color: #b6e2c2;
    }

    .item input[type="checkbox"] {
        width: 20px;
        height: 20px;
    }

    .textBox {
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding-left: 4px;
    }

    .timestamp {
        color: #666;
        font-size: 14px;
        margin-top: 3px;
    }

    /* ---------- 3点メニュー ---------- */
    .menuBtn {
        border: none;
        background: transparent;
        font-size: 20px;
        cursor: pointer;
        padding: 6px;
    }

    .menuBox {
        position: absolute;
        right: 10px;
        top: 50px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0px 2px 6px rgba(0,0,0,0.15);
        z-index: 20;
        padding: 5px 0;
        width: 140px;
    }

    .menuItem {
        padding: 10px;
        cursor: pointer;
        font-size: 16px;
    }

    .menuItem:hover {
        background: #f0f0f0;
    }

    /* ---------- 新規追加 ---------- */
    #addBox {
        margin-top: 20px;
        display: flex;
        gap: 8px;
    }

    #newItemName {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
    }

    #addItemBtn {
        padding: 10px 12px;
        border: none;
        background: #4a90e2;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
    }

    /* ---------- 全チェック解除 ---------- */
    #clearAllBtn {
        width: 100%;
        margin-top: 25px;
        padding: 12px 0;
        border: none;
        background: #bbb;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
    }

    .drag-ghost {
        opacity: 0.4;
    }
</style>
</head>

<body>

<h1>日常チェックアプリ</h1>

<div id="counter"></div>
<div id="items"></div>

<div id="addBox">
    <input type="text" id="newItemName" placeholder="新しい項目名を追加">
    <button id="addItemBtn" onclick="addItem()">追加</button>
</div>

<button id="clearAllBtn" onclick="clearAllChecks()">全てのチェックをオフにする</button>


<script>
/* ===============================
   データ処理
=============================== */
const storageKey = "dailyCheckItems";

const defaultItems = [
    { name: "鍵の施錠", icon:"", checked: false, timestamp: "" },
    { name: "窓の施錠", icon:"", checked: false, timestamp: "" },
    { name: "部屋の消灯", icon:"", checked: false, timestamp: "" }
];

function loadItems() {
    const saved = localStorage.getItem(storageKey);
    return saved ? JSON.parse(saved) : defaultItems;
}
function saveItems(items) {
    localStorage.setItem(storageKey, JSON.stringify(items));
}

function getNowText() {
    const now = new Date();
    const youbi = ["日","月","火","水","木","金","土"][now.getDay()];
    return `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()} (${youbi}) `
         + `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
}


/* ===============================
   カウンター
=============================== */
function updateCounter() {
    const items = loadItems();
    const total = items.length;
    const done  = items.filter(i => i.checked).length;

    document.getElementById("counter").textContent =
        `チェック済：${done} / ${total}（残り：${total-done}）`;
}


/* ===============================
   メニューを閉じる（全て）
=============================== */
function closeAllMenus() {
    document.querySelectorAll(".menuBox").forEach(m => m.remove());
}


/* ===============================
   描画処理
=============================== */
function render() {
    const items = loadItems();
    const container = document.getElementById("items");
    container.innerHTML = "";

    items.forEach((item, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "item-wrapper";

        const div = document.createElement("div");
        div.className = "item";
        if (item.checked) div.classList.add("checked");

        /* チェックボックス */
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = item.checked;
        cb.onchange = () => toggleCheck(idx);

        /* テキスト部分 */
        const textBox = document.createElement("div");
        textBox.className = "textBox";

        const label = document.createElement("div");
        label.textContent = (item.icon ? item.icon + " " : "") + item.name;

        const ts = document.createElement("span");
        ts.className = "timestamp";
        ts.textContent = item.timestamp || "";

        textBox.appendChild(label);
        textBox.appendChild(ts);

        /* 3点メニュー */
        const menuBtn = document.createElement("button");
        menuBtn.className = "menuBtn";
        menuBtn.textContent = "⋮";
        menuBtn.onclick = (e) => showMenu(e, idx);

        /* アイテム構成 */
        div.appendChild(cb);
        div.appendChild(textBox);
        div.appendChild(menuBtn);

        wrap.appendChild(div);
        container.appendChild(wrap);
    });

    updateCounter();
}


/* ===============================
   3点メニュー表示
=============================== */
function showMenu(event, index) {
    closeAllMenus();

    const menu = document.createElement("div");
    menu.className = "menuBox";

    /* 削除 */
    const del = document.createElement("div");
    del.className = "menuItem";
    del.textContent = "削除";
    del.onclick = () => { deleteItem(index); };

    /* 編集 */
    const edit = document.createElement("div");
    edit.className = "menuItem";
    edit.textContent = "編集";
    edit.onclick = () => { editItem(index); };

    /* 複製 */
    const copy = document.createElement("div");
    copy.className = "menuItem";
    copy.textContent = "複製";
    copy.onclick = () => { copyItem(index); };

    /* アイコン設定（絵文字入力） */
    const icon = document.createElement("div");
    icon.className = "menuItem";
    icon.textContent = "アイコン設定";
    icon.onclick = () => { setIcon(index); };

    menu.appendChild(del);
    menu.appendChild(edit);
    menu.appendChild(copy);
    menu.appendChild(icon);

    event.target.parentElement.appendChild(menu);
}


/* ===============================
   各機能
=============================== */
function toggleCheck(index) {
    const items = loadItems();
    const i = items[index];
    i.checked = !i.checked;
    i.timestamp = i.checked ? getNowText() : "";
    saveItems(items);
    render();
    initSortable();
}

function addItem() {
    const name = document.getElementById("newItemName").value.trim();
    if (!name) return;

    const items = loadItems();
    items.push({ name, icon:"", checked:false, timestamp:"" });

    saveItems(items);
    document.getElementById("newItemName").value = "";
    render();
    initSortable();
}

function deleteItem(index) {
    const items = loadItems();
    items.splice(index,1);
    saveItems(items);
    render();
    initSortable();
}

function editItem(index) {
    const items = loadItems();
    const newName = prompt("新しい名前を入力してください", items[index].name);
    if (newName !== null && newName.trim() !== "") {
        items[index].name = newName.trim();
        saveItems(items);
        render();
        initSortable();
    }
}

function copyItem(index) {
    const items = loadItems();
    const src = items[index];
    items.splice(index+1, 0, {
        name: src.name,
        icon: src.icon,
        checked: false,
        timestamp: ""
    });
    saveItems(items);
    render();
    initSortable();
}

function setIcon(index) {
    const icon = prompt("アイコン（絵文字）を入力してください\n空欄で削除できます");    
    const items = loadItems();
    items[index].icon = icon ? icon.trim() : "";
    saveItems(items);
    render();
    initSortable();
}

function clearAllChecks() {
    const items = loadItems();
    items.forEach(i => { i.checked = false; i.timestamp = ""; });
    saveItems(items);
    render();
    initSortable();
}


/* ===============================
   並び替え SortableJS
=============================== */
function initSortable() {
    const container = document.getElementById("items");

    if (container._sortable) container._sortable.destroy();

    container._sortable = Sortable.create(container, {
        animation: 150,
        ghostClass: "drag-ghost",
        forceFallback: true,
        fallbackTolerance: 3,
        onEnd: function(evt) {
            const items = loadItems();
            const moved = items.splice(evt.oldIndex, 1)[0];
            items.splice(evt.newIndex, 0, moved);
            saveItems(items);

            render();
            initSortable();
        }
    });
}


/* ===============================
   初期表示
=============================== */
render();
initSortable();
</script>

</body>
</html>
